# CI trigger on master branch, only for changes in included path
trigger:
  batch: true
  branches:
    include:
    - master
    - integration

variables:
  # You don't need to change anything here, unless you want to
  # publish docker image or documents to somewhere else.
  - group: kentoso-acr-credentials
  - group: kentoso-dev-twistlock-credentials
  - group: kentoso-private-pypi-url
  # - group: kentoso-doc-blobstorage

resources:
  repositories:
    - repository: templates
      type: github
      name: KenSciML/BuildTemplates
      endpoint: KenSciML
    - repository: self
      type: git
      ref: integration

stages:
- stage: A
  jobs:
  - template: python-package.yaml@templates
    parameters:
      publish_doc: false

- stage: B
  jobs:
  - job: Phase_2
    displayName: Build and Test - Windows
    pool:
      vmImage: windows-2019
    steps:
    - checkout: self
    - task: UsePythonVersion@0
      displayName: Use Python Version
      inputs:
        versionSpec: 3.6.8
    - task: CmdLine@2
      displayName: Set up test environment & add flag
      inputs:
        script: "# Set up test environment \npython3 -m pip install --upgrade wheel setuptools pip\npython3 setup.py install\n\n# Add flag for test environment\nENV IS_CICD=true\n\n# Force install of test dependencies before running pytest (should happen\n#   automatically but sometimes fails)\npython3 -m pip install .[test]\n\n"
    - task: CmdLine@2
      displayName: Install pytest
      inputs:
        script: python3 -m pip install pytest && pytest --doctest-modules --junitxml=junit/test-results.xml
    - task: PyTest@2
      displayName: Run PyTest
