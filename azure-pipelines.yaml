# CI trigger only for changes in included path
trigger:
  batch: true
  branches:
    include:
    - master
    - integration

resources:
  repositories:
    - repository: self
      type: git
      ref: integration

stages:
- stage: A_Test_Default
  jobs:
  - job: Test_Latest_Supported_PyVersion
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
    - task: UsePythonVersion@0
      displayName: Use Python Version
      inputs:
        versionSpec: 3.x
        checkLatest: true
    - task: ShellScript@2
      displayName: Build and Test
      inputs:
        scriptPath: build_test.sh
    - task: CmdLine@2
      displayName: Test Wheel Build
      inputs:
        script: 'RUN python3 setup.py bdist_wheel'
  - job: Test_Windows
    pool:
      vmImage: windows-2019
    steps:
    - checkout: self
    - task: UsePythonVersion@0
      displayName: Use Python Version
      inputs:
        versionSpec: 3.8.x
        checkLatest: true
    - task: CmdLine@2
      displayName: pywin32 workaround
      inputs:
        script: |
          python3 -m pip install pywin32 --upgrade
          where python
          python3 -m Lib\site-packages\win32\pywin32_postinstall.py -install
    - task: ShellScript@2
      displayName: Build and Test
      inputs:
        scriptPath: build_test.sh

- stage: B_Test_Options
  jobs:
  - job: Test_Earliest_Supported_PyVersion
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self
    - task: UsePythonVersion@0
      displayName: Use Python Version
      inputs:
        versionSpec: 3.6.x
        checkLatest: true
    - task: ShellScript@2
      displayName: Build and Test
      inputs:
        scriptPath: build_test.sh


